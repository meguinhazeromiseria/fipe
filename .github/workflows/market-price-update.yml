name: Market Price - Complete Update

on:
  # Roda automaticamente todo dia √†s 12h (hor√°rio de Bras√≠lia)
  schedule:
    - cron: '0 15 * * *'  # 15h UTC = 12h BRT
  
  # Permite executar manualmente
  workflow_dispatch:
    inputs:
      types_batch_size:
        description: 'Batch size - Types'
        required: false
        default: '100'
      types_max_batches:
        description: 'Max batches - Types'
        required: false
        default: '50'
      price_batch_size:
        description: 'Batch size - Prices'
        required: false
        default: '50'
      price_max_batches:
        description: 'Max batches - Prices'
        required: false
        default: '10'

jobs:
  complete-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: üè∑Ô∏è STEP 1 - Atualizar Vehicle Types
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "=================================================="
          echo "üè∑Ô∏è  STEP 1: Atualizando Vehicle Types"
          echo "=================================================="
          echo "üì¶ Batch size: ${{ github.event.inputs.types_batch_size || '100' }}"
          echo "üî¢ Max batches: ${{ github.event.inputs.types_max_batches || '50' }}"
          echo "‚è∞ Hor√°rio: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          python update_vehicle_types.py || echo "‚ö†Ô∏è Alguns erros no update de types, continuando..."
          echo ""
          echo "‚úÖ Step 1 conclu√≠do!"
          echo ""
      
      - name: ‚è≥ Aguardar entre steps
        run: |
          echo "‚è≥ Aguardando 10 segundos antes do pr√≥ximo step..."
          sleep 10
      
      - name: üí∞ STEP 2 - Atualizar Market Prices (FIPE)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "=================================================="
          echo "üí∞ STEP 2: Buscando Pre√ßos na FIPE"
          echo "=================================================="
          echo "üì¶ Batch size: ${{ github.event.inputs.price_batch_size || '50' }}"
          echo "üî¢ Max batches: ${{ github.event.inputs.price_max_batches || '10' }}"
          echo "‚è∞ Hor√°rio: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          python market_price_vehicles_scraper.py
          echo ""
          echo "‚úÖ Step 2 conclu√≠do!"
          echo ""
      
      - name: üìä STEP 3 - Estat√≠sticas Finais
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "=================================================="
          echo "üìä STEP 3: Estat√≠sticas Finais"
          echo "=================================================="
          python market_price_supabase_client.py || echo "‚ö†Ô∏è N√£o foi poss√≠vel buscar estat√≠sticas"
          echo ""
          echo "‚úÖ Workflow completo!"
      
      - name: üìã Gerar relat√≥rio
        if: always()
        run: |
          echo "## üöÄ Relat√≥rio - Complete Update" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ‚è∞ Informa√ß√µes da Execu√ß√£o" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Data/Hora:** $(date '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Branch:** ${{ github.ref_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### üè∑Ô∏è Step 1 - Vehicle Types" >> "$GITHUB_STEP_SUMMARY"
          echo "- Batch Size: ${{ github.event.inputs.types_batch_size || '100' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Max Batches: ${{ github.event.inputs.types_max_batches || '50' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Total estimado: $(( ${{ github.event.inputs.types_batch_size || '100' }} * ${{ github.event.inputs.types_max_batches || '50' }} )) ve√≠culos" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### üí∞ Step 2 - Market Prices" >> "$GITHUB_STEP_SUMMARY"
          echo "- Batch Size: ${{ github.event.inputs.price_batch_size || '50' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Max Batches: ${{ github.event.inputs.price_max_batches || '10' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Total estimado: $(( ${{ github.event.inputs.price_batch_size || '50' }} * ${{ github.event.inputs.price_max_batches || '10' }} )) ve√≠culos" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "‚úÖ Verifique os logs acima para resultados detalhados de cada step" >> "$GITHUB_STEP_SUMMARY"
      
      - name: üîî Notificar em caso de falha
        if: failure()
        run: |
          echo "‚ùå Workflow falhou!"
          echo ""
          echo "Poss√≠veis causas:"
          echo "- Credenciais do Supabase incorretas (SUPABASE_URL ou SUPABASE_SERVICE_ROLE_KEY)"
          echo "- API FIPE fora do ar ou com rate limit"
          echo "- Problema de conectividade"
          echo "- Erro no c√≥digo (vehicle_analyzer, market_price_scraper, etc)"
          echo ""
          echo "Verifique os logs de cada step acima para identificar onde falhou"
          exit 1