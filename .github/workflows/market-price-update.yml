name: Market Price - Complete Update

on:
  # Roda automaticamente todo dia Ã s 12h (horÃ¡rio de BrasÃ­lia)
  schedule:
    - cron: '0 15 * * *'  # 15h UTC = 12h BRT
  
  # Permite executar manualmente
  workflow_dispatch:
    inputs:
      types_batch_size:
        description: 'Batch size - Types'
        required: false
        default: '100'
      types_max_batches:
        description: 'Max batches - Types'
        required: false
        default: '50'
      price_batch_size:
        description: 'Batch size - Prices'
        required: false
        default: '50'
      price_max_batches:
        description: 'Max batches - Prices'
        required: false
        default: '10'

jobs:
  complete-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: ðŸ·ï¸ STEP 1 - Atualizar Vehicle Types
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "=================================================="
          echo "ðŸ·ï¸  STEP 1: Atualizando Vehicle Types"
          echo "=================================================="
          echo "ðŸ“¦ Batch size: ${{ github.event.inputs.types_batch_size || '100' }}"
          echo "ðŸ”¢ Max batches: ${{ github.event.inputs.types_max_batches || '50' }}"
          echo "â° HorÃ¡rio: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          python update_vehicle_types.py || echo "âš ï¸ Alguns erros no update de types, continuando..."
          echo ""
          echo "âœ… Step 1 concluÃ­do!"
          echo ""
      
      - name: â³ Aguardar entre steps
        run: |
          echo "â³ Aguardando 10 segundos antes do prÃ³ximo step..."
          sleep 10
      
      - name: ðŸ’° STEP 2 - Atualizar Market Prices (FIPE)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "=================================================="
          echo "ðŸ’° STEP 2: Buscando PreÃ§os na FIPE"
          echo "=================================================="
          echo "ðŸ“¦ Batch size: ${{ github.event.inputs.price_batch_size || '50' }}"
          echo "ðŸ”¢ Max batches: ${{ github.event.inputs.price_max_batches || '10' }}"
          echo "â° HorÃ¡rio: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          python market_price_vehicles_scraper.py
          echo ""
          echo "âœ… Step 2 concluÃ­do!"
          echo ""
      
      - name: ðŸ“Š STEP 3 - EstatÃ­sticas Finais
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "=================================================="
          echo "ðŸ“Š STEP 3: EstatÃ­sticas Finais"
          echo "=================================================="
          python market_price_supabase_client.py || echo "âš ï¸ NÃ£o foi possÃ­vel buscar estatÃ­sticas"
          echo ""
          echo "âœ… Workflow completo!"
      
      - name: ðŸ“‹ Gerar relatÃ³rio
        if: always()
        run: |
          echo "## ðŸš€ RelatÃ³rio - Complete Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â° InformaÃ§Ãµes da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- **Data/Hora:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Step 1 - Vehicle Types" >> $GITHUB_STEP_SUMMARY
          echo "- Batch Size: ${{ github.event.inputs.types_batch_size || '100' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Max Batches: ${{ github.event.inputs.types_max_batches || '50' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Total estimado: $(( ${{ github.event.inputs.types_batch_size || '100' }} * ${{ github.event.inputs.types_max_batches || '50' }} )) veÃ­culos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’° Step 2 - Market Prices" >> $GITHUB_STEP_SUMMARY
          echo "- Batch Size: ${{ github.event.inputs.price_batch_size || '50' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Max Batches: ${{ github.event.inputs.price_max_batches || '10' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Total estimado: $(( ${{ github.event.inputs.price_batch_size || '50' }} * ${{ github.event.inputs.price_max_batches || '10' }} )) veÃ­culos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP